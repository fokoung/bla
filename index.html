<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDM Adaptive Tutor: StuMMBE-Q & Usability</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Brain = (props) => <IconBase {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const GraduationCap = (props) => <IconBase {...props}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>;
        const HelpCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Lightbulb = (props) => <IconBase {...props}><line x1="9" y1="18" x2="15" y2="18"/><line x1="10" y1="22" x2="14" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 12 2a4.65 4.65 0 0 0-4.5 9.5c.7.76 1.15 1.52 1.34 2.5"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const Sliders = (props) => <IconBase {...props}><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></IconBase>;


        // --- PRE-TEST: STUMMBE-Q DATA (Krell, 2017) ---
        const STUMMBEQ_ITEMS = [
            // Mental Effort (ME)
            { id: 'ME1', text: "I expect to put little effort into answering the tasks.", type: 'ME', reverse: true },
            { id: 'ME2', text: "I don't intend to try hard to answer the tasks correctly.", type: 'ME', reverse: true },
            { id: 'ME3', text: "I will try hard to answer the tasks correctly.", type: 'ME', reverse: false },
            { id: 'ME4', text: "I will make an intellectual effort when answering the tasks.", type: 'ME', reverse: false },
            { id: 'ME5', text: "I don't intend to be particularly focused when answering the tasks.", type: 'ME', reverse: true },
            { id: 'ME6', text: "I will give my best to solve the tasks.", type: 'ME', reverse: false },
            
            // Mental Load (ML)
            { id: 'ML1', text: "I expect the contents of the tasks to be complicated.", type: 'ML', reverse: false },
            { id: 'ML2', text: "I expect the tasks to be challenging.", type: 'ML', reverse: false },
            { id: 'ML3', text: "I expect the tasks to be easy to work on.", type: 'ML', reverse: true },
            { id: 'ML4', text: "I expect the contents of the tasks to be easy to understand.", type: 'ML', reverse: true },
            { id: 'ML5', text: "I expect the tasks to be easy to solve.", type: 'ML', reverse: true },
            { id: 'ML6', text: "I expect the task structure to be complex.", type: 'ML', reverse: false }
        ];

        // --- POST-TEST: USABILITY DATA (SUS & UMUX-Lite) ---
        const SUS_ITEMS = [
            { id: 'SUS1', text: "I think that I would like to use this system frequently." },
            { id: 'SUS2', text: "I found the system unnecessarily complex." },
            { id: 'SUS3', text: "I thought the system was easy to use." },
            { id: 'SUS4', text: "I think that I would need the support of a technical person to be able to use this system." },
            { id: 'SUS5', text: "I found the various functions in this system were well integrated." },
            { id: 'SUS6', text: "I thought there was too much inconsistency in this system." },
            { id: 'SUS7', text: "I would imagine that most people would learn to use this system very quickly." },
            { id: 'SUS8', text: "I found the system very cumbersome to use." },
            { id: 'SUS9', text: "I felt very confident using the system." },
            { id: 'SUS10', text: "I needed to learn a lot of things before I could get going with this system." }
        ];

        const UMUX_LITE_ITEMS = [
            { id: 'UMUX1', text: "This system's capabilities meet my requirements." },
            { id: 'UMUX2', text: "This system is easy to use." }
        ];

        // --- QUIZ DATA ---
        const QUESTIONS = [
            // --- AFM QUESTIONS ---
            {
                id: 'A1', kc: 'AFM', cognitiveLevel: 'Theory',
                text: "Which core assumption distinguishes the Additive Factor Model (AFM) learning curve from simple percentage-correct metrics?",
                hints: [
                    "Think about the shape of a realistic learning curve. Does probability go from 0 to infinity?",
                    "A linear probability model (y = mx + b) is problematic because probability cannot exceed 100%.",
                    "AFM uses a transformation common in logistic regression to keep values between 0 and 1.",
                    "The model assumes the 'log-odds' (logit) is linear, not the raw probability itself."
                ],
                options: [
                    { id: 'A', text: "The probability of a correct response increases linearly with each practice opportunity.", isCorrect: false, feedback: "Incorrect. A linear probability model would eventually predict probabilities > 100%." },
                    { id: 'B', text: "The log-odds (logit) of a correct response increase linearly with practice.", isCorrect: true, feedback: "Correct! AFM uses logistic regression. The 'logit' is linear, creating the S-curve." },
                    { id: 'C', text: "Learning occurs in a discrete 'all-or-nothing' jump.", isCorrect: false, feedback: "Incorrect. That describes BKT." }
                ]
            },
            {
                id: 'A2', kc: 'AFM', cognitiveLevel: 'Interpretation',
                text: "In the AFM equation, the parameter theta (θ) represents the student intercept. What functional role does this parameter play?",
                hints: [
                    "Theta has only the 'i' subscript (student).",
                    "Consider a novice vs an expert entering the course.",
                    "This parameter accounts for where the student starts on the y-axis.",
                    "It captures the initial variability in prior knowledge."
                ],
                options: [
                    { id: 'A', text: "It captures the initial variability in prior knowledge across different students.", isCorrect: true, feedback: "Correct. It shifts the starting point of the learning curve." },
                    { id: 'B', text: "It weights the difficulty of the Knowledge Component.", isCorrect: false, feedback: "Incorrect. KC difficulty is usually beta (β)." },
                    { id: 'C', text: "It represents the learning rate.", isCorrect: false, feedback: "Incorrect. Learning rate is usually gamma (γ)." }
                ]
            },
            {
                id: 'A3', kc: 'AFM', cognitiveLevel: 'Pedagogy',
                text: "An AFM analysis reveals a Knowledge Component with a high intercept (β) but a near-zero learning rate (γ ≈ 0). What does this suggest?",
                hints: [
                    "Intercept is height. Slope is growth.",
                    "If intercept is high, they know it already.",
                    "If slope is zero, they aren't changing.",
                    "Skill is already mastered."
                ],
                options: [
                    { id: 'A', text: "The skill is difficult and requires practice.", isCorrect: false, feedback: "Incorrect." },
                    { id: 'B', text: "Students are gaming the system.", isCorrect: false, feedback: "Incorrect." },
                    { id: 'C', text: "The skill is 'easy' or already known; further practice is wasted.", isCorrect: true, feedback: "Correct. High start + no growth = Mastered." }
                ]
            },
            // --- PFM QUESTIONS ---
            {
                id: 'B1', kc: 'PFM', cognitiveLevel: 'Theory',
                text: "How does the Performance Factor Model (PFM) extend the AFM?",
                hints: [
                    "AFM counts 'Total Opportunities'.",
                    "PFM cares if you got the previous ones right or wrong.",
                    "It splits the count variable.",
                    "It separates Prior Corrects from Prior Incorrects."
                ],
                options: [
                    { id: 'A', text: "It splits the 'practice count' into prior correct and prior incorrect responses.", isCorrect: true, feedback: "Correct. It decouples the learning rate." },
                    { id: 'B', text: "It incorporates time-on-task.", isCorrect: false, feedback: "Incorrect." },
                    { id: 'C', text: "It adds a student-specific learning rate.", isCorrect: false, feedback: "Incorrect." }
                ]
            },
            {
                id: 'B2', kc: 'PFM', cognitiveLevel: 'Interpretation',
                text: "In a PFM analysis, if the coefficient for prior failures (ρ) is negative, what is the interpretation?",
                hints: [
                    "Negative coefficient means more X = less success.",
                    "Here X is 'Prior Failures'.",
                    "More failures predicting more failure.",
                    "This is 'Wheel-spinning'."
                ],
                options: [
                    { id: 'A', text: "Students learn more from mistakes.", isCorrect: false, feedback: "Incorrect (that would be positive)." },
                    { id: 'B', text: "Accumulating failures predicts future failure (Wheel-spinning).", isCorrect: true, feedback: "Correct. The student is stuck." },
                    { id: 'C', text: "Model failed to converge.", isCorrect: false, feedback: "Incorrect." }
                ]
            },
            {
                id: 'B3', kc: 'PFM', cognitiveLevel: 'Pedagogy',
                text: "A teacher sees a strongly negative PFM failure coefficient for a skill. What intervention is supported?",
                hints: [
                    "Data shows 'wheel-spinning'.",
                    "Is more practice good if they are stuck?",
                    "They need a change in strategy.",
                    "Remedial feedback."
                ],
                options: [
                    { id: 'A', text: "Increase practice problems.", isCorrect: false, feedback: "Incorrect. Reinforces frustration." },
                    { id: 'B', text: "Provide immediate remedial feedback or break skill down.", isCorrect: true, feedback: "Correct. Stop the wheel-spinning." },
                    { id: 'C', text: "Remove skill.", isCorrect: false, feedback: "Incorrect." }
                ]
            },
            // --- IFM QUESTIONS ---
            {
                id: 'C1', kc: 'IFM', cognitiveLevel: 'Theory',
                text: "The Instructional Factor Model (IFM) addresses which limitation of AFM/PFM?",
                hints: [
                    "Look at the name 'Instructional'.",
                    "Standard models ignore if the system helped you.",
                    "Does AFM know if you used a hint?",
                    "AFM ignores scaffolding."
                ],
                options: [
                    { id: 'A', text: "They treat all attempts as equal, ignoring hints/scaffolding.", isCorrect: true, feedback: "Correct. IFM accounts for help." },
                    { id: 'B', text: "They cannot handle missing values.", isCorrect: false, feedback: "Incorrect." },
                    { id: 'C', text: "They do not account for forgetting.", isCorrect: false, feedback: "Incorrect." }
                ]
            },
            {
                id: 'C2', kc: 'IFM', cognitiveLevel: 'Interpretation',
                text: "If IFM shows a negative coefficient for 'hint requests', how is this interpreted?",
                hints: [
                    "Correlation, not causation.",
                    "Who asks for hints? Those who don't know it.",
                    "Hint usage is a proxy for low prior knowledge.",
                    "It correlates negatively with immediate independent success."
                ],
                options: [
                    { id: 'A', text: "Hints increase correctness immediately.", isCorrect: false, feedback: "Incorrect." },
                    { id: 'B', text: "Heavy reliance on hints correlates with lower independent knowledge.", isCorrect: true, feedback: "Correct. It's a proxy for struggle." },
                    { id: 'C', text: "Hints are poorly designed.", isCorrect: false, feedback: "Incorrect." }
                ]
            },
            {
                id: 'C3', kc: 'IFM', cognitiveLevel: 'Pedagogy',
                text: "The 'Assistance Dilemma': Hint usage lowers immediate performance metrics, but...",
                hints: [
                    "Performance vs Learning.",
                    "Performance is now. Learning is later.",
                    "Scaffolding helps build the mental model.",
                    "Short-term dip, long-term gain."
                ],
                options: [
                    { id: 'A', text: "Short-term performance decreases, but long-term learning occurs.", isCorrect: true, feedback: "Correct. Scaffolding is necessary for learning even if it lowers 'score' now." },
                    { id: 'B', text: "The model is flawed.", isCorrect: false, feedback: "Incorrect." },
                    { id: 'C', text: "Students are gaming.", isCorrect: false, feedback: "Incorrect." }
                ]
            }
        ];

        // --- COMPONENT: STUMMBE-Q SURVEY ---
        const StuMMBEQSurvey = ({ onComplete }) => {
            const [responses, setResponses] = useState({});
            
            const handleRating = (itemId, rating) => {
                setResponses(prev => ({ ...prev, [itemId]: rating }));
            };

            const isComplete = STUMMBEQ_ITEMS.every(item => responses[item.id] !== undefined);

            const handleSubmit = () => {
                if(isComplete) onComplete(responses);
            };

            return (
                <div className="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col animate-in">
                    <div className="bg-slate-50 px-8 py-6 border-b border-slate-100">
                        <div className="flex items-center gap-3 mb-2">
                            <span className="bg-blue-100 text-blue-700 p-2 rounded-lg"><FileText size={20}/></span>
                            <h2 className="text-xl font-bold text-slate-900">Pre-Assessment Survey (StuMMBE-Q)</h2>
                        </div>
                        <p className="text-slate-600 text-sm">
                            Please answer the following questions regarding your <strong>expectations</strong> for the upcoming tasks. 
                            (1 = Strongly Disagree, 7 = Strongly Agree)
                        </p>
                    </div>
                    
                    <div className="p-8 bg-white space-y-6 max-h-[60vh] overflow-y-auto">
                        {STUMMBEQ_ITEMS.map((item, index) => (
                            <div key={item.id} className="pb-4 border-b border-slate-50 last:border-0">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <span className="text-slate-700 font-medium text-sm md:text-base w-full md:w-1/2">
                                        {index + 1}. {item.text}
                                    </span>
                                    <div className="flex gap-1 md:gap-2 shrink-0">
                                        {[1, 2, 3, 4, 5, 6, 7].map((val) => (
                                            <button
                                                key={val}
                                                onClick={() => handleRating(item.id, val)}
                                                className={`w-8 h-8 md:w-10 md:h-10 rounded-full text-xs md:text-sm font-bold transition-all ${
                                                    responses[item.id] === val 
                                                    ? 'bg-blue-600 text-white shadow-md scale-110' 
                                                    : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                                                }`}
                                            >
                                                {val}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="p-6 bg-slate-50 border-t border-slate-100 flex justify-end">
                        <button 
                            onClick={handleSubmit}
                            disabled={!isComplete}
                            className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-all flex items-center gap-2"
                        >
                            Submit & Start Quiz <ChevronRight className="w-4 h-4" />
                        </button>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: USABILITY SURVEY (SUS & UMUX-Lite) ---
        const UsabilitySurvey = ({ onComplete }) => {
            const [responses, setResponses] = useState({});
            
            const handleRating = (itemId, rating) => {
                setResponses(prev => ({ ...prev, [itemId]: rating }));
            };

            const allSusAnswered = SUS_ITEMS.every(i => responses[i.id] !== undefined);
            const allUmuxAnswered = UMUX_LITE_ITEMS.every(i => responses[i.id] !== undefined);
            const isComplete = allSusAnswered && allUmuxAnswered;

            return (
                <div className="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col animate-in">
                    <div className="bg-slate-50 px-8 py-6 border-b border-slate-100">
                        <div className="flex items-center gap-3 mb-2">
                            <span className="bg-emerald-100 text-emerald-700 p-2 rounded-lg"><Sliders size={20}/></span>
                            <h2 className="text-xl font-bold text-slate-900">Post-Assessment: Usability</h2>
                        </div>
                        <p className="text-slate-600 text-sm">
                            Now that you have finished the tasks, please rate your experience using the system itself.
                        </p>
                    </div>
                    
                    <div className="p-8 bg-white space-y-10 max-h-[60vh] overflow-y-auto">
                        
                        {/* SUS Section */}
                        <div>
                            <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b">1. System Usability Scale (SUS)</h3>
                            <p className="text-sm text-slate-500 mb-6">Scale: 1 (Strongly Disagree) to 5 (Strongly Agree)</p>
                            <div className="space-y-6">
                                {SUS_ITEMS.map((item, index) => (
                                    <div key={item.id} className="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-4 border-b border-slate-50 last:border-0">
                                        <span className="text-slate-700 font-medium text-sm md:text-base w-full md:w-1/2">
                                            {index + 1}. {item.text}
                                        </span>
                                        <div className="flex gap-2 shrink-0">
                                            {[1, 2, 3, 4, 5].map((val) => (
                                                <button
                                                    key={val}
                                                    onClick={() => handleRating(item.id, val)}
                                                    className={`w-8 h-8 md:w-10 md:h-10 rounded-lg text-sm font-bold transition-all ${
                                                        responses[item.id] === val 
                                                        ? 'bg-emerald-600 text-white shadow-md' 
                                                        : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                                                    }`}
                                                >
                                                    {val}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* UMUX-Lite Section */}
                        <div>
                            <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b">2. UMUX-Lite</h3>
                            <p className="text-sm text-slate-500 mb-6">Scale: 1 (Strongly Disagree) to 7 (Strongly Agree)</p>
                            <div className="space-y-6">
                                {UMUX_LITE_ITEMS.map((item, index) => (
                                    <div key={item.id} className="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-4 border-b border-slate-50 last:border-0">
                                        <span className="text-slate-700 font-medium text-sm md:text-base w-full md:w-1/2">
                                            {index + 1}. {item.text}
                                        </span>
                                        <div className="flex gap-1 shrink-0">
                                            {[1, 2, 3, 4, 5, 6, 7].map((val) => (
                                                <button
                                                    key={val}
                                                    onClick={() => handleRating(item.id, val)}
                                                    className={`w-8 h-8 md:w-10 md:h-10 rounded-full text-xs font-bold transition-all ${
                                                        responses[item.id] === val 
                                                        ? 'bg-indigo-600 text-white shadow-md' 
                                                        : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                                                    }`}
                                                >
                                                    {val}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                    </div>

                    <div className="p-6 bg-slate-50 border-t border-slate-100 flex justify-end">
                        <button 
                            onClick={() => onComplete(responses)}
                            disabled={!isComplete}
                            className="bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-all flex items-center gap-2"
                        >
                            Submit & Finish <CheckCircle className="w-4 h-4" />
                        </button>
                    </div>
                </div>
            );
        };

        const Header = ({ current, total, phase }) => (
            <header className="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
                <div className="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <div className="bg-indigo-600 p-2 rounded-lg">
                            <GraduationCap className="w-6 h-6 text-white" />
                        </div>
                        <div>
                            <h1 className="text-xl font-bold text-slate-900 leading-tight">EDM Adaptive Tutor</h1>
                            <p className="text-xs text-slate-500 font-medium">Knowledge Tracing Diagnostic</p>
                        </div>
                    </div>
                    {phase === 'quiz' && (
                        <div className="flex items-center gap-4">
                            <div className="hidden sm:block text-right">
                                <p className="text-xs text-slate-400 uppercase tracking-wider font-semibold">Progress</p>
                                <p className="text-lg font-bold text-indigo-600 font-mono">{current} <span className="text-slate-300">/</span> {total}</p>
                            </div>
                            <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center border-2 border-indigo-100 relative">
                                <span className="absolute inset-0 rounded-full border-2 border-indigo-600" style={{ clipPath: `circle(${current/total * 50 + 50}% at 50% 50%)` }}></span>
                                <span className="text-xs font-bold text-slate-600">{(current/total * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    )}
                </div>
            </header>
        );

        // --- MAIN APP ---
        function App() {
            // App States: 'start' -> 'survey_pre' -> 'quiz' -> 'survey_post' -> 'finish'
            const [appState, setAppState] = useState('start'); 
            
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isSubmitted, setIsSubmitted] = useState(false);
            
            // Scaffolding State
            const [hintLevel, setHintLevel] = useState(0); 

            // Data State
            const [sessionStartTime, setSessionStartTime] = useState(0);
            const [questionStartTime, setQuestionStartTime] = useState(0);
            const [interactions, setInteractions] = useState([]);
            const [preSurveyData, setPreSurveyData] = useState(null);
            const [postSurveyData, setPostSurveyData] = useState(null);

            const currentQ = QUESTIONS[currentQIndex];

            // 1. User Clicks Start
            const handleStartClick = () => {
                setAppState('survey_pre');
            };

            // 2. User Completes Pre-Survey
            const handlePreSurveyComplete = (data) => {
                setPreSurveyData(data);
                const now = Date.now();
                setSessionStartTime(now);
                setQuestionStartTime(now);
                setAppState('quiz');
            };

            // 3. Quiz Logic
            const handleOptionSelect = (id) => {
                if (isSubmitted) return;
                setSelectedOption(id);
            };

            const handleHintRequest = () => {
                if (hintLevel < 4) {
                    setHintLevel(prev => prev + 1);
                }
            }

            const handleSubmit = () => {
                if (!selectedOption) return;
                
                const endTime = Date.now();
                const durationSeconds = (endTime - questionStartTime) / 1000;

                setIsSubmitted(true);
                
                const option = currentQ.options.find(o => o.id === selectedOption);
                const isCorrect = option?.isCorrect || false;

                const record = {
                    questionId: currentQ.id,
                    knowledgeComponent: currentQ.kc,
                    cognitiveLevel: currentQ.cognitiveLevel,
                    selectedOption: selectedOption,
                    isCorrect: isCorrect,
                    timeSpentSeconds: parseFloat(durationSeconds.toFixed(2)),
                    hintsUsed: hintLevel,
                    timestamp: new Date().toISOString()
                };
                
                setInteractions(prev => [...prev, record]);
            };

            const handleNext = () => {
                if (currentQIndex < QUESTIONS.length - 1) {
                    setCurrentQIndex(prev => prev + 1);
                    setSelectedOption(null);
                    setIsSubmitted(false);
                    setHintLevel(0);
                    setQuestionStartTime(Date.now());
                } else {
                    // Go to Post-Survey (Usability) instead of finish
                    setAppState('survey_post');
                }
            };

            // 4. User Completes Post-Survey
            const handlePostSurveyComplete = (data) => {
                setPostSurveyData(data);
                setAppState('finish');
            }

            const handleReset = () => {
                setAppState('start');
                setCurrentQIndex(0);
                setSelectedOption(null);
                setIsSubmitted(false);
                setHintLevel(0);
                setInteractions([]);
                setPreSurveyData(null);
                setPostSurveyData(null);
                setSessionStartTime(0);
                setQuestionStartTime(0);
            };

            // 5. Download Data
            const handleDownloadData = () => {
                const totalCorrect = interactions.filter(i => i.isCorrect).length;
                const totalTime = (Date.now() - sessionStartTime) / 1000;

                const exportData = {
                    sessionId: `session_${new Date().getTime()}`,
                    completedAt: new Date().toISOString(),
                    totalTimeSeconds: parseFloat(totalTime.toFixed(2)),
                    score: {
                        correct: totalCorrect,
                        total: QUESTIONS.length,
                        percentage: parseFloat(((totalCorrect / QUESTIONS.length) * 100).toFixed(1))
                    },
                    stuMMBEQ_Survey: {
                        responses: preSurveyData,
                        meta: { instrument: "StuMMBE-Q (Krell, 2017)", type: "Pre-Task" }
                    },
                    usability_metrics: {
                        responses: postSurveyData,
                        meta: { 
                            instruments: ["SUS (Bangor et al., 2009)", "UMUX-Lite (Lewis et al., 2015)"],
                            type: "Post-Task" 
                        }
                    },
                    interactions: interactions
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `edm_complete_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- VIEW RENDERERS ---

            if (appState === 'start') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-slate-800 to-slate-900 flex items-center justify-center p-6">
                        <div className="max-w-xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in duration-500">
                            <div className="h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                            <div className="p-10 text-center">
                                <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Brain className="w-10 h-10 text-indigo-600" />
                                </div>
                                <h1 className="text-3xl font-bold text-slate-900 mb-3">EDM Assessment System</h1>
                                <p className="text-slate-500 mb-8 leading-relaxed">
                                    Welcome to the Intelligent Tutoring System prototype. 
                                    This session includes a pre-assessment survey, a diagnostic quiz, and a post-assessment usability survey.
                                </p>
                                <button 
                                    onClick={handleStartClick}
                                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-indigo-200 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
                                >
                                    Start Session <ArrowRight className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </div>
                )
            }

            if (appState === 'survey_pre') {
                return (
                    <div className="min-h-screen bg-slate-50 font-sans flex flex-col">
                        <Header current={0} total={QUESTIONS.length} phase="survey" />
                        <main className="flex-1 w-full max-w-5xl mx-auto p-4 md:p-6 flex flex-col items-center justify-center">
                            <StuMMBEQSurvey onComplete={handlePreSurveyComplete} />
                        </main>
                    </div>
                )
            }

            if (appState === 'survey_post') {
                return (
                    <div className="min-h-screen bg-slate-50 font-sans flex flex-col">
                        <Header current={QUESTIONS.length} total={QUESTIONS.length} phase="survey" />
                        <main className="flex-1 w-full max-w-5xl mx-auto p-4 md:p-6 flex flex-col items-center justify-center">
                            <UsabilitySurvey onComplete={handlePostSurveyComplete} />
                        </main>
                    </div>
                )
            }

            if (appState === 'finish') {
                const totalCorrect = interactions.filter(i => i.isCorrect).length;
                const percentage = (totalCorrect / QUESTIONS.length) * 100;
                
                return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 font-sans">
                    <div className="bg-white p-10 rounded-3xl shadow-xl max-w-2xl w-full text-center border border-slate-200">
                    <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-in zoom-in duration-500">
                        <CheckCircle className="w-12 h-12 text-green-600" />
                    </div>
                    <h1 className="text-4xl font-bold text-slate-800 mb-2">Diagnostic Complete</h1>
                    <p className="text-slate-600 mb-10 text-lg">You have completed all tasks and surveys.</p>
                    
                    <div className="mb-8 p-6 bg-slate-50 rounded-2xl border border-slate-200">
                        <div className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Final Score</div>
                        <div className="text-5xl font-bold text-indigo-600 mb-2">{totalCorrect} / {QUESTIONS.length}</div>
                        <div className="text-slate-400 font-medium">{percentage.toFixed(0)}% Accuracy</div>
                    </div>

                    <div className="flex flex-col gap-3 max-w-xs mx-auto">
                        <button 
                            onClick={handleDownloadData}
                            className="flex items-center justify-center gap-2 w-full px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-semibold shadow-md"
                        >
                            <Download className="w-5 h-5" />
                            Download Complete Data (.json)
                        </button>
                        
                        <button 
                            onClick={handleReset}
                            className="flex items-center justify-center gap-2 w-full px-6 py-3 bg-white text-slate-700 border border-slate-300 rounded-xl hover:bg-slate-50 transition-colors font-semibold"
                        >
                            <RefreshCw className="w-4 h-4" />
                            Start New Session
                        </button>
                    </div>
                    </div>
                </div>
                );
            }

            // QUIZ VIEW
            return (
                <div className="min-h-screen bg-slate-50 font-sans flex flex-col">
                <Header current={currentQIndex + 1} total={QUESTIONS.length} phase="quiz" />

                <main className="flex-1 w-full max-w-5xl mx-auto p-4 md:p-6 flex flex-col items-center">
                    
                    <div className="w-full bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col min-h-[500px]">
                        {/* Question Header */}
                        <div className="bg-slate-50 px-8 py-6 border-b border-slate-100 flex justify-between items-start">
                        <div>
                            <div className="flex gap-2 mb-3">
                                <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide border border-indigo-200">
                                    Domain: {currentQ.kc}
                                </span>
                                <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold uppercase tracking-wide border border-purple-200">
                                    {currentQ.cognitiveLevel}
                                </span>
                            </div>
                            <h2 className="text-xl md:text-2xl text-slate-900 font-semibold leading-relaxed">
                                {currentQ.text}
                            </h2>
                        </div>
                        </div>

                        <div className="p-8 flex-1 flex flex-col">
                        {/* Options */}
                        <div className="space-y-4 mb-8">
                            {currentQ.options.map((option) => (
                            <button
                                key={option.id}
                                onClick={() => handleOptionSelect(option.id)}
                                disabled={isSubmitted}
                                className={`w-full text-left p-4 md:p-5 rounded-xl border-2 transition-all duration-200 flex items-start gap-4 group relative overflow-hidden ${
                                isSubmitted 
                                    ? option.isCorrect 
                                    ? 'border-green-500 bg-green-50/50' 
                                    : selectedOption === option.id 
                                        ? 'border-red-500 bg-red-50/50'
                                        : 'border-slate-100 opacity-60 grayscale'
                                    : selectedOption === option.id
                                    ? 'border-indigo-600 bg-indigo-50 shadow-md ring-2 ring-indigo-200 ring-opacity-50'
                                    : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50 hover:shadow-sm'
                                }`}
                            >
                                <div className={`mt-0.5 w-8 h-8 rounded-lg flex items-center justify-center border text-sm font-bold shrink-0 transition-colors ${
                                isSubmitted 
                                ? option.isCorrect 
                                    ? 'bg-green-500 border-green-500 text-white' 
                                    : selectedOption === option.id 
                                    ? 'bg-red-500 border-red-500 text-white'
                                    : 'border-slate-300 text-slate-400 bg-slate-50'
                                : selectedOption === option.id
                                    ? 'bg-indigo-600 border-indigo-600 text-white'
                                    : 'border-slate-300 text-slate-500 bg-white group-hover:border-indigo-400 group-hover:text-indigo-600'
                                }`}>
                                {option.id}
                                </div>
                                <span className={`text-base md:text-lg leading-relaxed ${
                                    isSubmitted && option.isCorrect ? 'font-semibold text-green-900' : 
                                    isSubmitted && selectedOption === option.id ? 'font-medium text-red-900' :
                                    'text-slate-700'
                                }`}>
                                {option.text}
                                </span>
                                
                                {/* Visual Marker for Outcome */}
                                {isSubmitted && option.isCorrect && (
                                    <CheckCircle className="absolute right-4 top-1/2 -translate-y-1/2 text-green-500/20 w-12 h-12" />
                                )}
                            </button>
                            ))}
                        </div>

                        {/* Scaffolding / Hints Area */}
                        {!isSubmitted && (
                            <div className="mt-auto">
                                {/* HINT DISPLAY */}
                                {hintLevel > 0 && (
                                    <div className="space-y-2 mb-4 animate-in">
                                    {currentQ.hints.slice(0, hintLevel).map((h, idx) => (
                                        <div key={idx} className={`p-4 rounded-xl border flex gap-4 shadow-sm ${
                                        idx === hintLevel - 1 
                                            ? 'bg-amber-50 border-amber-200 text-amber-900' 
                                            : 'bg-slate-50 border-slate-100 text-slate-500 opacity-80'
                                        }`}>
                                        <div className={`p-2 rounded-full h-fit shrink-0 ${
                                            idx === hintLevel - 1 ? 'bg-amber-100' : 'bg-slate-200'
                                        }`}>
                                            <Lightbulb className={`w-5 h-5 ${
                                                idx === hintLevel - 1 ? 'text-amber-700' : 'text-slate-500'
                                            }`} />
                                        </div>
                                        <div>
                                            <p className={`font-bold text-xs uppercase mb-1 ${
                                                idx === hintLevel - 1 ? 'text-amber-800' : 'text-slate-400'
                                            }`}>Scaffolding Level {idx + 1}</p>
                                            <p className="text-sm leading-relaxed">{h}</p>
                                        </div>
                                        </div>
                                    ))}
                                    </div>
                                )}
                                
                                {/* HINT BUTTON */}
                                {hintLevel < 4 && (
                                    <button 
                                        onClick={handleHintRequest}
                                        className="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center gap-2 transition-colors px-4 py-2 rounded-lg hover:bg-indigo-50 self-start group"
                                    >
                                        <HelpCircle className="w-5 h-5 group-hover:scale-110 transition-transform" />
                                        <span>
                                        {hintLevel === 0 ? "Stuck? Request an Intelligent Hint" : `Need more help? (Show Hint ${hintLevel + 1}/4)`}
                                        </span>
                                        
                                        {/* Visual Progress Dots for Hints */}
                                        <div className="flex gap-1 ml-2">
                                            {[1, 2, 3, 4].map(i => (
                                                <div key={i} className={`w-1.5 h-1.5 rounded-full ${i <= hintLevel ? 'bg-indigo-400' : 'bg-indigo-100'}`} />
                                            ))}
                                        </div>
                                    </button>
                                )}
                            </div>
                        )}

                        {/* Feedback Area */}
                        {isSubmitted && (
                            <div className={`mt-auto p-6 rounded-xl border flex items-start gap-4 animate-in shadow-sm ${
                            currentQ.options.find(o => o.id === selectedOption)?.isCorrect 
                                ? 'bg-emerald-50 border-emerald-200 text-emerald-900' 
                                : 'bg-rose-50 border-rose-200 text-rose-900'
                            }`}>
                            {currentQ.options.find(o => o.id === selectedOption)?.isCorrect 
                                ? <CheckCircle className="w-8 h-8 shrink-0 text-emerald-600" /> 
                                : <XCircle className="w-8 h-8 shrink-0 text-rose-600" />
                            }
                            <div className="flex-1">
                                <h3 className="font-bold text-lg mb-1">
                                {currentQ.options.find(o => o.id === selectedOption)?.isCorrect ? 'Correct!' : 'Incorrect'}
                                </h3>
                                <div className="prose prose-sm max-w-none">
                                    <p className="opacity-90 leading-relaxed text-base">
                                        {currentQ.options.find(o => o.id === selectedOption)?.feedback}
                                    </p>
                                </div>
                            </div>
                            </div>
                        )}
                        </div>

                        {/* Footer / Controls */}
                        <div className="bg-slate-50 p-6 border-t border-slate-100 flex justify-end">
                        {!isSubmitted ? (
                            <button 
                            onClick={handleSubmit}
                            disabled={!selectedOption}
                            className="bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-10 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex items-center gap-2"
                            >
                            Submit Answer
                            </button>
                        ) : (
                            <button 
                            onClick={handleNext}
                            className="bg-slate-900 hover:bg-slate-800 text-white px-10 py-3 rounded-xl font-bold shadow-lg transition-all flex items-center gap-2 transform active:scale-95"
                            >
                            {currentQIndex < QUESTIONS.length - 1 ? 'Next Question' : 'Finish Diagnostic'} <ChevronRight className="w-4 h-4" />
                            </button>
                        )}
                        </div>
                    </div>

                </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
